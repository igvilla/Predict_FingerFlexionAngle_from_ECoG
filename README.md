# Predict_FingerFlexionAngle_from_ECoG
This collaborative project was part of a graduate level course on Brain Computer Interfaces (BCIs) at UPenn. The project involved using provided ECoG data along with data from detected finger angles of a glove. The objective was to create (in a set time period) an algorithm to try detecting/predicting the finger angles of a patient based on the detected ECoG activity. Such a project can be expanded and further advanced into a more complex BCI prosthetic glove that assists disabled patients in recovering control over their hand and finger movements. This was my first big project exploring the practice of data science and machine learning concepts to biomedical applications. 

NOTE: all code for this project was performed in Python. 


## SUMMARY:

The final algorithm made involved the use of an Elastic Net machine learning model. Noisy channels were removed from the electrocorticography data prior to then applying a band-pass filter between 75-200 Hz. The data was split into overlapping windows with a window length of 100ms and window displacement of 50ms. The following feature set was extracted for each sliding window: time average and frequency domain average between 8-12 Hz, 75-95 Hz, 95-115 Hz, 125-145 Hz, 145-160 Hz, and 160-175 Hz. All of these features were calculated on all channels (excluding only the noisy channels, as described earlier). A 150ms delay was also applied, accounting for the time delay between ECoG activity and the flexion of a finger. This was done by calculating the features for the preceding three time windows and adding it to the feature-array (R-matrix). After this, features were then standardized. 

The elastic net machine learning model was trained separately (after optimizing the alpha hyperparameter) on each finger for each patient by using the developed R-matrix (feature-array) and the downsampled finger flexion data. Predictions were calculated on the testing ECoG data for each patient and finger, followed by post-processing on the predicted regressions. This involved an interpolation to the target sampling rate and convolution of traces with a Gaussian function. 


## DETAILED EXPLANATION OF FINAL ALGORITHM:

### Background:

The goal of this project was to train and create a supervised machine learning algorithm that is able to predict the finger angles of patients by using ECoG data and human glove data (which contained the angles of each finger of the hand) from multiple patients. The goal was to maximize the correlation of the model in order to maximize the effectiveness of the model. This project was part of a graduate level course focused on the practice of brain computer interfaces (BCIs). Data research and development of this algorithm was restricted to a set time period. 

### Methods:

#### Removal of Bad Channels and Pre-processing:

The creation of this model started with the identification and removal of all noisy/irrelevant channels for ECoG data, which included channel 55 for the first patient and channels 21 and 38 for the second patient. Based off of literature research, frequencies above 50 Hz were found to be useful for finger movement decoding. After performing a Fast-Fourier Transform (FFT) on the data, high power was found at 60 Hz (likely due to electrical noise), so the range of 50-75 Hz was avoided. A fourth order butterworth bandpass filter was applied (with cutoff frequencies of 75 and 200 Hz) and run both forward and backwards as a way of removing phase distortion. Cutoff frequencies of 75-115 Hz were used to isolate the high gamma band, which showed significant activity changes in the literature. In summary, although the general cutoff was initialized to be 75-200 Hz, an additional argument was added in the case that other frequency bands (including the gamma band) had useful features. Additionally, there was a resonant frequency of 60 Hz noise at 120 and 180 Hz, so these frequencies were also avoided when extracting features in relevant frequency bands. The data was also split into overlapping windows with a window length of 100ms and window displacement of 50ms. 

#### Feature Extraction and Standardization:

The following feature set was extracted for each sliding window: time average and frequency domain average between 8-12 Hz, 75-95 Hz, 95-115 Hz, 125-145 Hz, 145-160 Hz, and 160-175 Hz. All of these features were calculated on all channels (excluding only the noisy channels, as described earlier). A 150ms delay was also applied, accounting for the time delay between ECoG activity and the flexion of a finger. This was done by calculating the features for the preceding three time windows and adding it to the feature-array (R-matrix). In other words, each column of the feature array was restricted to N-2 time windows, followed by repeating each column N times (except this time, the starting and ending time windows were shifted by one, now accounting for one of the previously neglected time windows). This modification of the feature array takes into account the time delay experienced between ECoG activity and the reacting motion of each finger. Several other features were included at first (such as line length, area, energy, and several others), but these features were eventually removed after they were found to not explain much of the variance in the data and had little effect in improving the correlation. After this, the feature set was standardized by use of the training set mean and standard deviation for each feature. Different forms of dimensionality reduction were also attempted, such as Principal Component Analysis (PCA), LSTM, and t-SNE. However, all these forms of dimensionality reduction were found to only lower the correlation since the components determined did not explain enough of the variance present in the data. Therefore, no dimensionality reduction was included in the final model. 

#### Supervised Learning Regression Models:

Many of the initially attempted models included support vector regression (SVR), K-nearest neighbors regressor, RANSAC regressor, and random forest regressor. Among these, SVR was initially the most successful model. After several attempts with other models, it was clear that the main problem occurring was overfitting, indicating that regularization methods were needed in order to fix the effectiveness of the model on the testing set. Lasso and Ridge were then considered. The Lasso and Ridge methods would both add penalty to coefficients that were causing overfitting (a form of eliminating unimportant features) in similar ways. The only difference is that in Ridge no coefficients were dropped all the way to zero, which can have a negative effect by maintaining unimportant/useless features. Both models were attempted before eventually trying Elastic Net, which combines the benefits from both methods (Lasso and Ridge) into one. Individually for each finger of each patient, the elastic net model was tuned to be able to determine the optimal alpha hyperparameter (used to weigh the contribution of the penalty) for the prediction. Cross validation was applied during this process of determining the optimal hyperparameters; this assisted in determining these optimal hyperparameters before making any actual predictions with a finalized model. 

#### Post-processing:

The final step after training the model was post-processing, which showed to greatly improve the resulting correlation. This initially involved smoothing the curve by the method of moving average box (via convolution), in which the number of box points was chosen to be 15. This successfully reduced the noise in the curve and clearly showed a flatter curve at points in the plot where finger flexion was not occurring. After the smoothing of the curve, Gaussian filtering/smoothing was attempted, which proved to further improve the correlation by adding in an additional component: scaling up the spikes in the curve, which greatly helped due to the small amplitude of the spikes found in our curve (compared to the spikes found for true finger angles). This successfully smoothed the curve while also scaling up the spikes. Finally, after the above post-processing steps, interpolation was performed in order to match the sampling rate of the glove data. Zero-interpolation repeated the value of each prediction for the length of the time window before the new window started. Due to the right-aligned sliding window arrangement, the final predictions were padded at the beginning by using the first prediction value.

### Results:

The final correlation of the model was about 0.47, or 47%. With more time for trial and error, this correlation could likely be further improved. The fourth finger's flexion was generally correlated with the third and fifth fingers' flexion. It was consistently noticed that the fourth finger had a strong correlation while the third finger and fifth finger always had a much poorer correlation. The fingers are controlled with the ulnar nerve and radial nerve, with the ulnar nerve connecting to the third, fourth, and fifth fingers. Since the nerves for the fourth and fifth fingers are intertwined, it is more difficult to move each of them separately. Therefore, when a patient was instructed to move the fourth finger, the patient was likely to flex the third and fifth finger as well, explaining why the third and fifth fingers likely showed the worst corelations among all fingers. 

### Future Improvements:

One of the models attempted (but with little time remaining) was a Recurrent Neural Network (RNN). It used almost all the same features as Elastic Net at first. The number of features was later decreased in an attempt to avoid overfitting; the same time windows were used. The feature set for the final RNN model used included the power in the 75-95, 96-115, 125-145, and 146-160 Hz bands. The data was split into training and testing sets (as before), using all available data. A batch of four time windows of feature data were fed to the model at once; the prior ten time windows of features were also given to the model. This corresponds to the 1.5 seconds before the finger angle flex times. This was determined by looking at spectrograms of the neural response near the times of finger flexion; some response was found in the gamma and upper gamma range up to 1.5 seconds before the stimulus. This RNN model used one hidden layer with 20 units and a learning rate of 5E-5. Additionally, a dropout rate of 0.4 was added. Mean squared error was used as the loss function for the model. All hyperparameters were manually chosen with the goal being to avoid overfitting. This model was trained for 20 epochs on each patient; after 20 epochs, the error in the testing data began to increase. Similar post-processing techniques were also applied, and after fixing the problem of overfitting, this model seemed very promising, performing only slightly worse than the Elastic Net model overall. An important result to keep in mind is that the RNN model performed better on fingers three and five when compared to the Elastic Net model, which are the two fingers the Elastic Net model struggled with significantly. The overall correlation for all fingers together, however, resulted worse than the Elastic Net model. This was likely because the problem of overfitting was not completely eliminated in the RNN model. 

Further attempts at refining this model has the potential to outperform the Elastic Net model and result in even more effective predicitions. Potential corrections in order to further improve this model include removing even more features (further avoid overfitting), addition of noise to the input and output as a way of avoiding the local minima, and reducing the number of time windows. Further improvements in this model has high potential in substantially improving the final model for finger angle predictions. Further tuning hyperparameters of models, creation of unattempted models (especially one such as a convolutional network), and extracting new features are all additional methods that may help in the goal of strengthening the correlation of the final model. 
