# Predict_FingerFlexionAngle_from_ECoG
This collaborative project was part of a graduate level course on Brain Computer Interfaces (BCIs) at UPenn. The project involved using provided ECoG data along with data from detected finger angles of a glove. The objective was to create an algorithm to try detecting/predicting the finger angles of a patient based on the detected ECoG activity. Such a project can be expanded and further advanced into a more complex BCI prosthetic glove that assists disabled patients in recovering control over their hand and finger movements.


SUMMARY:

The final algorithm made involved the use of an elastic net machine learning model. Noisy channels were removed from the electrocorticography data prior to then applying a band-pass filter between 75-200 Hz. The data was split into overlapping windows with a window length of 100ms and window displacement of 50ms. The following feature set was extracted for each sliding window: time average and frequency domain average between 8-12 Hz, 75-95 Hz, 95-115 Hz, 125-145 Hz, 145-160 Hz, and 160-175 Hz. All of these features were calculated on all channels (excluding only the noisy channels, as described earlier). A 150ms delay was also applied, accounting for the time delay between ECoG activity and the flexion of a finger. This was done by calculating the features for the preceding three time windows and adding it to the feature-array (R-matrix). After this, features were then standardized. 

The elastic net machine learning model was trained separately (after optimizing the alpha hyperparameter) on each finger for each patient by using the developed R-matrix (feature-array) and the downsampled finger flexion data. Predictions were calculated on the testing ECoG data for each patient and finger, followed by post-processing on the predicted regressions. This involved an interpolation to the target sampling rate and convolution of traces with a Gaussian function. 


DETAILED EXPLANATION OF FINAL ALGORITHM:

The creation of this model started with the identification and removal of all noisy/irrelevant channels for ECoG data, which included channel 55 for the first patient and channels 21 and 38 for the second patient. Based off of literature research, frequencies above 50 Hz were found to be useful for finger movement decoding. After performing a Fast-Fourier Transform (FFT) on the data, high power was found at 60 Hz (likely due to electrical noise), so the range of 50-75 Hz was avoided. A fourth order butterworth bandpass filter was applied (with cutoff frequencies of 75 and 200 Hz) and run both forward and backwards as a way of removing phase distortion. Cutoff frequencies of 75-115 Hz were used to isolate the high gamma band, which showed significant activity changes in the literature. In summary, although the general cutoff was initialized to be 75-200 Hz, an additional argument was added in the case that other frequency bands (including the gamma band) had useful features. Additionally, there was a resonant frequency of 60 Hz noise at 120 and 180 Hz, so these frequencies were also avoided when extracting features in relevant frequency bands. 

The data was split into overlapping windows with a window length of 100ms and window displacement of 50ms. The following feature set was extracted for each sliding window: time average and frequency domain average between 8-12 Hz, 75-95 Hz, 95-115 Hz, 125-145 Hz, 145-160 Hz, and 160-175 Hz. All of these features were calculated on all channels (excluding only the noisy channels, as described earlier). A 150ms delay was also applied, accounting for the time delay between ECoG activity and the flexion of a finger. This was done by calculating the features for the preceding three time windows and adding it to the feature-array (R-matrix). In other words, each column of the feature array was restricted to N-2 time windows, followed by repeating each column N times (except this time, the starting and ending time windows were shifted by one, now accounting for one of the previously neglected time windows). This modificatino of the feature array takes into account the time delay experienced between ECoG activity and the reacting motion of each finger. After this, the feature set was standardized by use of the training set mean and standard deviation for each feature. 

After several attempts with other models (such as SVR), it was clear that the problem of overfitting was occuring, indicating that regularization methods were needed in order to fix the effectiveness of the model on the testing set. Lasso and Ridge were considered at first. The Lasso and Ridge methods would both add penalty to coefficients that were causing overfitting (a form of eliminating unimportant features) in similar ways. The only difference is that in Ridge no coefficients are dropped all the way to zero, which can have a negative effect by maintaining unimportant/useless features. Elastic Net was eventually used instead, which combines the benefits from both methods into one. Individually for each finger of each patient, the elastic net model was tuned to be able to determine the optimal alpha hyperparameter (used to weigh the contribution of the penalty) used in the prediction. This optimized value was used in the model to develop more accurate predictions. 

The final step after training the model was post-processing, which initially involved smoothing the curve by the method of moving average box (via convolution), in which the number of box points was chosen to be 15. This successfully reduced the noise in the curve and clearly showed a flatter curve at points in the plot where finger flexion was not occurring. After the smoothing of the curve, Gaussian filtering/smoothing was attempted, which proved to further improve the correlation by adding in the additional component of scaling up spikes in the curve, which greatly helped due to the small amplitude of the spikes found in our curve (compared to the spikes found for true finger angles). This successfully smoothed the curve while also scaling up the spikes. 

Finally, after the above post-processing steps, interpolation was performed in order to match the sampling rate of the glove data. Zero-interpolation repeated the value of each prediction for the length of the time window before the new window started. Due to the right-aligned sliding window arrangement, the final predictions were padded at the beginning by using the first prediction value. 
